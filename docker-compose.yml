services:
  ts-oauth:
    image: tailscale/tailscale:latest
    container_name: ts-oauth
    hostname: ${CONTAINER_NAME}-${ENV_NAME}
    env_file:
      - .env
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}?ephemeral=${EPHEMERAL_MODE}
      - TS_EXTRA_ARGS=--advertise-tags=tag:${TAILSCALE_TAG}
      - TS_STATE_DIR=/var/lib/tailscale
    volumes:
      - ${PWD}/ts-oauth/state:/var/lib/tailscale
    networks:
      - server-network
    devices:
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
    restart: unless-stopped

  discord-bot:
    container_name: discord-bot
    build:
      dockerfile: src/discord_bot/Dockerfile
      context: ${PWD}
    env_file:
        - .env
    environment:
      - DISCORD_TOKEN=${DISCORD_TOKEN}
    networks:
      - server-network
    depends_on:
      - ts-oauth
      - server-controller
    restart: unless-stopped

  server-controller:
    build:
      context: ${PWD}
      dockerfile: src/server_controller/Dockerfile
    env_file: .env
    volumes:
      - ${PWD}/server:/app/server
    networks:
      - server-network
    ports:
      - "80:80"

networks:
  server-network:
    driver: bridge